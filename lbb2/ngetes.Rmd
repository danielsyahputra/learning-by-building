---
title: "ngetes"
author: "Daniel Syahputra"
date: "1/30/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(shiny)
library(shinydashboard)
library(tidyverse)
library(lubridate)
library(scales)
library(echarts4r)
library(highcharter)
library(htmlwidgets)


# Data Preparation
marketing <- read.csv("datasets/marketing_data.csv")

marketing$Income <- parse_number(marketing$Income)
marketing$Dt_Customer <- mdy(marketing$Dt_Customer)

marketing$Education[marketing$Education == "Graduation"] <- "Undergraduate"
marketing$Education[marketing$Education == "2n Cycle"] <- "Master"

status <- c("YOLO", "Alone", "Absurd")
marketing$Marital_Status[marketing$Marital_Status %in% status] <- "Single"

marketing <- marketing %>%
  mutate_if(is.character, as.factor)

average_income <- aggregate(Income ~ Education + Marital_Status, data=marketing, FUN=mean)

imputed_data <- left_join(marketing[is.na(marketing$Income),],
                          average_income,
                          by = c("Education", "Marital_Status"))

imputed_data$Income.x <- imputed_data$Income.y
imputed_data <- imputed_data %>% select(-Income.y)
colnames(imputed_data)[5] <- "Income"

marketing <- full_join(marketing,
                       imputed_data,
                       by = c('ID',
                              'Year_Birth',
                              'Education',
                              'Marital_Status',
                              'Kidhome',
                              'Teenhome',
                              'Dt_Customer',
                              'Recency',
                              'MntWines',
                              'MntFruits',
                              'MntMeatProducts',
                              'MntFishProducts',
                              'MntSweetProducts',
                              'MntGoldProds',
                              'NumDealsPurchases',
                              'NumWebPurchases',
                              'NumCatalogPurchases',
                              'NumStorePurchases',
                              'NumWebVisitsMonth',
                              'AcceptedCmp3',
                              'AcceptedCmp4',
                              'AcceptedCmp5',
                              'AcceptedCmp1',
                              'AcceptedCmp2',
                              'Response',
                              'Complain',
                              'Country'))
marketing <- marketing  %>%
  mutate(Income = coalesce(Income.x, Income.y)) %>%
  select(-c("Income.x", "Income.y"))
```

```{r}
marketing <- marketing %>% 
  mutate(Age = as.integer(format(Sys.Date(), "%Y")) - Year_Birth)

convert_age <- function(age){ 
    if(age >= 58){
      age <- "> Boomers II" 
    }else if(age >= 42){
      age <- "Gen X"
    }else if (age >= 26){
      age <- "Millennials"
    } else {
      age <- "Gen Z"
    }
}

marketing$Era <- sapply(X = marketing$Age, 
                            FUN = convert_age) 
marketing$Era <- as.factor(marketing$Era)
str(marketing)
```

```{r}
colSums(is.na(marketing))
```
```{r}
marketing %>% 
  filter(Income < 0)
```
```{r}
hcoptslang <- getOption("highcharter.lang")
hcoptslang$thousandsSep <- "*"
options(highcharter.lang = hcoptslang)
```


```{r}
valueBoxSpark <- function(value, title, sparkobj = NULL, subtitle, info = NULL, 
                            icon = NULL, color = "aqua", width = 4, href = NULL){
    
    shinydashboard:::validateColor(color)
    
    if (!is.null(icon))
      shinydashboard:::tagAssert(icon, type = "i")
    
    info_icon <- tags$small(
      tags$i(
        class = "fa fa-info-circle fa-lg",
        title = info,
        `data-toggle` = "tooltip",
        style = "color: rgba(255, 255, 255, 0.75);"
      ),
      # bs3 pull-right 
      # bs4 float-right
      class = "pull-right float-right"
    )
    
    boxContent <- div(
      class = paste0("small-box bg-", color),
      div(
        class = "inner",
        tags$small(title),
        if (!is.null(sparkobj)) info_icon,
        h3(value),
        if (!is.null(sparkobj)) sparkobj,
        p(subtitle)
      ),
      # bs3 icon-large
      # bs4 icon
      if (!is.null(icon)) div(class = "icon-large icon", icon, style = "z-index; 0")
    )
    
    if (!is.null(href)) 
      boxContent <- a(href = href, boxContent)
    
    div(
      class = if (!is.null(width)) paste0("col-sm-", width), 
      boxContent
    )
  }
```

```{r}
hcCustomerIncome <- hchart(
      density(marketing$Income),
      type = "area", name = "Income",
      color = "#db902e"
    ) %>% 
      hc_title(text = "Customer's Income") %>% 
      hc_tooltip(crosshairs = TRUE,
                 borderWidth = 2,
                 pointFormat = '<span style="color:{series.color}">{series.name}</span>:
                       <b>${point.x:.4f}</b><br/>')

    vbCustomerIncome <- valueBoxSpark(
      value = dollar(mean(marketing$Income), 
                     prefix = "$", big.mark = ",",
                     decimal.mark = ".", 
                     accuracy = 0.01),
      title = toupper("AVERAGE CUSTOMER INCOME"),
      sparkobj = hcCustomerIncome,
      info = "This is the customer income based on marketing data",
      subtitle = tagList("Customer Income ",
                         HTML("&uarr;"),
                         percent(mean(marketing$Income), 
                                 decimal.mark = ".", 
                                 accuracy = .01)),
      icon = icon("money-bill-wave"),
      color = "teal",
      href = NULL
    )
    
vbCustomerIncome
```

```{r}
max(marketing$Income)
```
```{r}
customerSpent <- marketing %>% 
  select(MntWines, MntFruits, MntMeatProducts, MntFishProducts, MntSweetProducts, MntGoldProds) %>% 
  mutate(TotalSpent = MntWines + MntFruits + MntMeatProducts + 
           MntFishProducts + MntSweetProducts + MntGoldProds)

hchart(
      density(customerSpent$TotalSpent),
      type = "area", name = "Total Spent",
      color = "#db902e"
    ) %>% 
      hc_xAxis(min = 0) %>% 
      hc_title(text = "Customer Total Spent") %>% 
      hc_tooltip(crosshairs = TRUE,
                 borderWidth = 2,
                 pointFormat = '<span style="color:{series.color}">{series.name}</span>:
                       <b>${point.x:.4f}</b><br/>')
```

```{r}
max(customerSpent$TotalSpent)
```
```{r}
customerPurchases <- marketing %>% 
  select(NumWebPurchases, NumCatalogPurchases, NumStorePurchases) %>% 
  mutate(TotalPurchases = NumWebPurchases + NumCatalogPurchases + NumStorePurchases)

hchart(
      density(customerPurchases$TotalPurchases),
      type = "area", name = "Total Purchases",
      color = "#db902e"
    ) %>% 
      hc_xAxis(min = 0,
               color = "#f0f0f0") %>% 
      hc_size(height = 200) %>% 
      hc_title(text = "Customers Total Purchases",
               style = list(color = "#f0f0f0", fontSize =16)) %>% 
      hc_tooltip(crosshairs = TRUE,
                 borderWidth = 2,
                 pointFormat = '<span style="color:{series.color}">{series.name}</span>:
                       <b>{point.x:.1f}</b><br/>')
```
```{r}
mean(customerPurchases$TotalPurchases)
```

```{r}
str(marketing)
```
```{r}
levels(marketing$Education)
```
```{r}
marketing %>% 
      filter(Marital_Status %in% c("Married"),
             Education %in% c("Basic"),
             Era %in% c("Gen X"))
```

```{r}
marketing %>% 
  group_by(Marital_Status) %>% 
  summarise(MeanIncome = mean(Income)) %>% 
  arrange(MeanIncome) %>% 
  e_chart(Marital_Status) %>% 
  e_pie(MeanIncome, radius = c("50%", "75%")) %>% 
  e_theme_custom("marketing_dashboar/www/chart_theme.json") %>% 
  e_title(
    text = "Mean Income by Marital Status",
    left = "center",
    top = "0"
  ) %>% 
  e_legend(F) %>% 
  e_tooltip(
    trigger = "item",
    formatter = JS("
                    function(params){return(
                        '<b>' + params.name + '</b>'
                           + ' : $'
                           + (params.value).toLocaleString('en-US', 
                           {maximumFractionDigits : 2, minimumFractionDigits: 2})
                           )}
                           ")
  )
```
```{r}
marketing %>% 
  mutate(TotalSpent = MntWines + MntFruits + MntMeatProducts + 
           MntFishProducts + MntSweetProducts + MntGoldProds) %>% 
  group_by(Marital_Status) %>% 
  summarise(MeanTotalSpent = mean(TotalSpent)) %>% 
  arrange(desc(MeanTotalSpent)) %>% 
  e_chart(Marital_Status) %>% 
  e_bar(MeanTotalSpent) %>% 
  e_flip_coords() %>% 
  e_y_axis(inverse = T) %>% 
  e_theme_custom("marketing_dashboar/www/chart_theme.json") %>% 
  e_title(
    text = "Mean Total Spent by Marital Status",
    left = "center",
    top = "0"
  ) %>% 
  e_legend(show = F) %>% 
  e_axis_labels(x = "Mean Total Spent") %>% 
  e_x_axis(
    name = "Mean Total Spent",
    nameLocation = "center",
    nameGap = "25",
    formatter = e_axis_formatter(style = c("currency"), currency = "USD")) %>%
  e_tooltip(
    trigger = "item",
    formatter = JS(
      "
       function(params){return(
       '<b>' + params.name + '</b>'
       + ' : $' 
       + params.value[0]
       )}
       "
    )
  )
```
```{r}
getCustomDataCustomers <- function(input, feature) {
    param <- input
    data <- "" 
    if (feature == "Income") {
      if (param == "Marital Status") {
        data <- marketing %>% 
          group_by(Marital_Status)
      } else if (param == "Education") {
        data <- marketing %>% 
          group_by(Education) 
      } else {
        data <- marketing %>% 
          group_by(Era)
      }
      data <- data %>% 
        summarise(MeanIncome = mean(Income)) %>% 
        arrange(MeanIncome)
      return(data)
    } else {
      data <- marketing %>% 
        mutate(TotalSpent = MntWines + MntFruits + MntMeatProducts + 
                 MntFishProducts + MntSweetProducts + MntGoldProds)
      if (param == "Marital Status") {
        data <- data %>% 
          group_by(Marital_Status)
      } else if (param == "Education") {
        data <- data %>% 
          group_by(Education)
      } else {
        data <- data %>% 
          group_by(Era)
      }
      data <- data %>% 
        summarise(MeanTotalSpent = mean(TotalSpent)) %>% 
        arrange(desc(MeanTotalSpent))
      return(data)
    }
    
  }
```

```{r}
getCustomDataCustomers(input = "Education", feature = "Income")
```

```{r}
productSpent <- marketing %>% 
  select(Marital_Status,Education, Era, MntWines, MntFruits, MntMeatProducts,
         MntFishProducts, MntSweetProducts, MntGoldProds)

colnames(productSpent) <- c("Marital_Status", "Education", "Era",
                            "Wines", "Fruits", "Meats", 
                            "Fishs", "Sweets", "Gold")
```

```{r}
productSpent %>% 
  e_charts() %>% 
  e_histogram(Wines) %>% 
  e_theme_custom("marketing_dashboar/www/chart_theme.json") %>% 
  e_title(
    text = "Customers Amount Spent for Wines",
    left = "center",
    top = "0"
  ) %>% 
  e_legend(top = "30") %>% 
  e_axis_labels(x = "Amount Spent") %>% 
  e_x_axis(
    name = "Amount Spent",
    nameLocation = "center",
    nameGap = "25",
    formatter = e_axis_formatter(style = c("currency"), currency = "USD")) %>%
  e_tooltip(
    trigger = "item",
    formatter = JS(
      "
       function(params){return(
       '<b>Freq</b>'
       + ' : ' 
       + params.value[1]
       )}
       "
    )
  )
```


```{r}
productSpent <- productSpent %>% 
  group_by(Marital_Status) %>% 
  summarise(Wines = mean(Wines), 
            Fruits = mean(Fruits),
            Meats = mean(Meats),
            Fishs = mean(Fishs),
            Sweets = mean(Sweets),
            Gold = mean(Gold)) %>% 
  mutate(MeanTotalSpent = Wines + Fruits + Meats + Fishs + Sweets + Gold) %>% 
  arrange(desc(MeanTotalSpent))
```


```{r}
productSpent %>% 
  e_chart(Marital_Status) %>% 
  e_bar(Wines, stack = "grp") %>% 
  e_bar(Fruits, stack = "grp") %>% 
  e_bar(Meats, stack = "grp") %>% 
  e_bar(Fishs, stack = "grp") %>% 
  e_bar(Sweets, stack = "grp") %>% 
  e_bar(Gold, stack = "grp") %>% 
  e_flip_coords() %>% 
  e_y_axis(inverse = T) %>% 
  e_theme_custom("marketing_dashboar/www/chart_theme.json") %>% 
  e_title(
    text = "Mean Total Spent of Each Product",
    left = "center",
    top = "0"
  ) %>% 
  e_legend(top = "30") %>% 
  e_axis_labels(x = "Mean Total Spent") %>% 
  e_x_axis(
    name = "Mean Total Spent",
    nameLocation = "center",
    nameGap = "25",
    formatter = e_axis_formatter(style = c("currency"), currency = "USD")) %>%
  e_tooltip(
    trigger = "item",
    formatter = JS(
      "
       function(params){return(
       '<b>' + params.name + '</b>'
       + ' : $' 
       + params.value[0]
       )}
       "
    )
  )
```

```{r}
```


```{r}
productPurchasesPlatform <- marketing %>% 
  select(MntWines, MntFruits, MntMeatProducts,
         MntFishProducts, MntSweetProducts, MntGoldProds,
         NumWebPurchases, NumCatalogPurchases, NumStorePurchases)

colnames(productPurchasesPlatform) <- 
  c("Wines", "Fruits", "Meats", 
    "Fishs", "Sweets", "Gold",
    "Web", "Catalog", "Store")

# productPurchasesPlatform <- productPurchasesPlatform %>% 
#   pivot_longer(cols = c("Wines", "Fruits", "Meats", 
#                         "Fishs", "Sweets", "Gold"),
#                names_to = "ProductType") %>% 
#   select(-value)
# 
# productPurchasesPlatform %>% 
#   group_by(ProductType) %>% 
#   summarise(Web = mean(Web),
#             Catalog = mean(Catalog),
#             Store = mean(Store))
productPurchasesPlatform
```

```{r}
hcWebPurchases <- hchart(
  density(marketing$NumWebPurchases),
  type = "area",
  name = "Web Purchases",
  color = "#db902e"
) %>% 
  hc_xAxis(min = 0) %>% 
  hc_size(height = 200) %>% 
  hc_title(text = "Web Purchases",
           style = list(color = "#f0f0f0", fontSize =16)) %>% 
  hc_tooltip(borderWidth = 2,
             crosshairs = T,
             pointFormat = '<span style="color:{series.color}">{series.name}</span>:
                       <b>{point.x:.1f}</b><br/>')

vbWebPurchases <- valueBoxSpark(
  value = sum(marketing$NumWebPurchases),
  title = toupper("TOTAL WEB PURCHASES"),
  sparkobj = hcWebPurchases,
  info = "Number of purchases made through the company's website",
  subtitle = NULL,
  icon = icon("store"),
  href = NULL
)
```

```{r}
hcCatalogPurchases <- hchart(
  density(marketing$NumCatalogPurchases),
  type = "area",
  name = "Catalog Purchases",
  color = "#db902e"
) %>% 
  hc_xAxis(min = 0) %>% 
  hc_size(height = 200) %>% 
  hc_title(text = "Catalog Purchases",
           style = list(color = "#f0f0f0", fontSize =16)) %>% 
  hc_tooltip(borderWidth = 2,
             crosshairs = T,
             pointFormat = '<span style="color:{series.color}">{series.name}</span>:
                       <b>{point.x:.1f}</b><br/>')

vbWebPurchases <- valueBoxSpark(
  value = sum(marketing$NumCatalogPurchases),
  title = toupper("TOTAL CATALOG PURCHASES"),
  sparkobj = hcCatalogPurchases,
  info = "Number of purchases made using catalog",
  subtitle = NULL,
  icon = icon("store"),
  href = NULL
)
```

```{r}
hcStorePurchases <- hchart(
      density(marketing$NumStorePurchases),
      type = "area",
      name = "Store Purchases",
      color = "#db902e"
    ) %>% 
      hc_xAxis(min = 0) %>% 
      hc_size(height = 200) %>% 
      hc_title(text = "Store Purchases",
               style = list(color = "#f0f0f0", fontSize =16)) %>% 
      hc_tooltip(borderWidth = 2,
                 crosshairs = T,
                 pointFormat = '<span style="color:{series.color}">{series.name}</span>:
                       <b>{point.x:.1f}</b><br/>')
    
    vbStorePurchases <- valueBoxSpark(
      value = sum(marketing$NumStorePurchases),
      title = toupper("TOTAL STORE PURCHASES"),
      sparkobj = hcStorePurchases,
      info = "Number of purchases made directly in store",
      subtitle = NULL,
      icon = icon("store"),
      href = NULL
    )
    
```

```{r}
platformPurchases <- marketing %>% 
  select(Marital_Status, Education, Era,
         NumWebPurchases, NumCatalogPurchases, NumStorePurchases)

colnames(platformPurchases) <- c("Marital_Status", "Education", "Era",
                                 "Web", "Catalog", "Store")

platformPurchases %>% 
  group_by(Marital_Status) %>% 
  summarise(Web = sum(Web),
            Catalog = sum(Catalog),
            Store = sum(Store)) %>% 
  mutate(TotalPurchases = Web + Store + Catalog) %>% 
  arrange(desc(Web)) %>% 
  e_chart(Marital_Status) %>% 
  e_pie(Web, roseType = "radius") %>% 
  e_theme_custom("marketing_dashboar/www/chart_theme.json") %>% 
  e_title(
        text = glue("Total Purchases on Web"),
        left = "center",
        top = "0"
      ) %>% 
  e_legend(F) %>% 
  e_tooltip(
    trigger = "item",
    formatter = JS("
                function(params){return(
                 '<b>' + params.name + '</b>'
                 + ' : ' 
                 + params.value
                 )}
                       ")
  )

```




















